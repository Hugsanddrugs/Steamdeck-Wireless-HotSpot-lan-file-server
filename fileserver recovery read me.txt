File Server Recovery Script Documentation

üìã SCRIPT OVERVIEW

File: file_server_recovery.sh
Purpose: Automated recovery of Steam Deck File Server hotspot functionality after SteamOS updates
Created: For resolving post-update DNSMasq removal and service conflicts
Risk Level: Low (only fixes specific, verified issues)

---

üéØ WHAT THIS SCRIPT DOES

Primary Function:

Restores file server hotspot capability after SteamOS updates remove critical dependencies and reset configurations.

Specific Problems Fixed:

1. DNSMasq Missing - SteamOS updates often remove the dnsmasq package required for hotspot DHCP
2. systemd-resolved Conflict - Re-enabled service conflicts with NetworkManager's hotspot DHCP
3. Stuck Processes - Orphaned file server processes holding port 5000
4. NetworkManager State - Ensures clean service state for hotspot operation

---

üîß WHY THESE FIXES ARE NEEDED

SteamOS Update Impact:

¬∑ DNSMasq Removal: Hotspot activation fails with "ip-config-unavailable" error
¬∑ Service Reset: systemd-resolved gets re-enabled, blocking port 53 from dnsmasq
¬∑ Configuration Wipe: Read-only filesystem resets break package installations

Symptoms Without This Script:

```
‚ùå Hotspot activation failed
‚ùå Hotspot setup failed, falling back to LAN
‚ùå Devices can't obtain IP addresses from hotspot
‚ùå Port 5000 conflicts preventing server startup
```

---

üõ†Ô∏è HOW THE SCRIPT WORKS

Execution Flow:

```
1. Preflight Checks
   ‚îÇ
2. DNSMasq Installation Verification
   ‚îÇ
3. systemd-resolved Conflict Resolution
   ‚îÇ
4. Hotspot Profile Validation
   ‚îÇ
5. File Server Environment Check
   ‚îÇ
6. Process Cleanup & Port Clearing
   ‚îÇ
7. NetworkManager Restart
   ‚îÇ
8. Final System Status Report
```

Key Safety Features:

¬∑ Dependency Validation: Checks command availability before execution
¬∑ Root Prevention: Blocks execution as root user
¬∑ Error Handling: Continues on non-critical failures
¬∑ State Verification: Confirms actions were successful
¬∑ Idempotent Design: Safe to run multiple times

---

üöÄ COMMANDS & EXECUTION

Script Location:

```bash
~/FileServer/file_server_recovery.sh
```

Making Script Executable:

```bash
chmod +x ~/FileServer/file_server_recovery.sh
```

Running the Script:

```bash
# Navigate to script directory
cd ~/FileServer

# Execute the recovery script
./file_server_recovery.sh
```

Expected Password Prompts:

The script will naturally prompt for your sudo password when needed for:

¬∑ Package installation (pacman -S dnsmasq)
¬∑ Service management (systemctl commands)
¬∑ Process termination (pkill, kill commands)
¬∑ Port scanning (ss, network inspection)

Post-Recovery Server Startup:

```bash
# After script completes, start your file server:
cd ~/FileServer
sudo systemctl stop firewalld
source venv/bin/activate
python unified_server.py hotspot
```

---

üìä SCRIPT OUTPUT EXPLANATION

Normal Successful Output:

```
üîß SteamOS File Server Recovery Script
üìã Starting system state analysis...

1. Checking DNSMasq...
   ‚úÖ DNSMasq present: dnsmasq 2.90-2

2. Checking systemd-resolved conflict...
   ‚úÖ systemd-resolved not active

3. Checking hotspot profile...
   ‚úÖ Hotspot profile exists
   ‚úÖ Hotspot SSID correct: DeckFileServer

4. Checking file server environment...
   ‚úÖ Virtual environment exists
   ‚úÖ Flask dependencies available
   ‚úÖ Server files present

5. Cleaning up stuck processes...
   ‚úÖ No stuck server processes found
   ‚úÖ Port 5000 is clear

6. Restarting NetworkManager...
   ‚úÖ NetworkManager restarted

üéØ RECOVERY ACTIONS COMPLETE
```

Recovery Scenario Output:

```
1. Checking DNSMasq...
   ‚ùå DNSMasq missing - reinstalling...
   ‚úÖ DNSMasq installed successfully

2. Checking systemd-resolved conflict...
   ‚ö†Ô∏è  systemd-resolved active - stopping and disabling...
   ‚úÖ systemd-resolved stopped and disabled

5. Cleaning up stuck processes...
   ‚ö†Ô∏è  Found running server processes: 12345
   ‚úÖ Killed stuck server processes
```

---

üîÑ WHEN TO RUN THIS SCRIPT

Trigger Events:

¬∑ After any SteamOS system update
¬∑ When hotspot mode stops working
¬∑ When seeing "Hotspot activation failed" errors
¬∑ After system reboots that break file server functionality

Frequency:

¬∑ Run once after each SteamOS update
¬∑ As needed when hotspot functionality breaks
¬∑ Safe to run multiple times if unsure

---

üîç TROUBLESHOOTING

Common Issues:

Script won't run:

```bash
# Make executable if permission denied
chmod +x file_server_recovery.sh
```

DNSMasq installation fails:

```bash
# Manual fallback
steamos-readonly disable
sudo pacman -S dnsmasq --noconfirm
steamos-readonly enable
```

Port 5000 still blocked:

```bash
# Manual cleanup
sudo pkill -f "unified_server.py"
sudo ss -tulpn | grep 5000
sudo kill -9 $(sudo lsof -t -i:5000)
```

Logging:

¬∑ Script outputs to terminal (no log file)
¬∑ Check server logs: tail -f ~/FileServer/unified_server.log
¬∑ System logs: sudo journalctl -u NetworkManager

---

üé™ INTEGRATION WITH EXISTING WORKFLOW

Current Startup Process:

```bash
cd ~/FileServer
sudo systemctl stop firewalld
pkill -f "unified_server.py" 2>/dev/null || true
source venv/bin/activate
python unified_server.py hotspot
```

Enhanced Post-Update Process:

```bash
# 1. Run recovery script after SteamOS updates
./file_server_recovery.sh

# 2. Then proceed with normal startup
sudo systemctl stop firewalld
source venv/bin/activate
python unified_server.py hotspot
```

---

üìù MAINTENANCE

Configuration Variables (Edit if needed):

```bash
HOTSPOT_PROFILE_NAME="DeckFileServer"    # Your hotspot name
HOTSPOT_SSID="DeckFileServer"           # Hotspot SSID
FILE_SERVER_DIR="/home/deck/FileServer" # Your server location
```

Update Considerations:

¬∑ Script designed for current SteamOS behavior
¬∑ May need updates if SteamOS changes package management
¬∑ Monitor for new conflict patterns after major updates

---

‚úÖ SUCCESS VALIDATION

After running the script and starting your server, verify:

1. Hotspot activates (no "falling back to LAN" messages)
2. Server starts on port 5000 (sudo ss -tulpn | grep 5000)
3. Devices can connect to DeckFileServer WiFi
4. Web interface accessible at http://10.42.0.1:5000
5. File operations work (upload/download functional)

This script encapsulates all the diagnostic knowledge and fixes we discovered through our forensic analysis, providing a single-command recovery solution for your file server project.
